<!DOCTYPE html>  <html> <head>   <title>muon.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               muon.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @fileOverview</span>
<span class="cm"> * @name muon.js</span>
<span class="cm"> * @author Daisuke Mino daisuke.mino@gmail.com</span>
<span class="cm"> * @url https://github.com/minodisk/muon</span>
<span class="cm"> * @version 0.1.2</span>
<span class="cm"> * @license MIT License</span>
<span class="cm"> */</span>
<span class="p">;(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">Module</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">toString</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span>
        <span class="p">,</span> <span class="nx">isArray</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">,</span> <span class="nx">Constructor</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
        <span class="p">,</span> <span class="nx">copyDeeply</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">key</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isArray</span><span class="p">(</span><span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="p">{};</span>
                <span class="nx">copyDeeply</span><span class="p">(</span><span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">child</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">,</span> <span class="nx">inheritPrototype</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">Parent</span><span class="p">,</span> <span class="nx">Child</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
          <span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Constructor</span><span class="p">();</span>
          <span class="nx">Child</span><span class="p">.</span><span class="nx">__super__</span> <span class="o">=</span> <span class="nx">Parent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
          <span class="nx">Child</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Child</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">,</span> <span class="nx">__modules</span> <span class="o">=</span> <span class="p">{};</span>
  
      <span class="cm">/**</span>
<span class="cm">       * Define module.</span>
<span class="cm">       * @param {String} id Module ID.</span>
<span class="cm">       * @param {Function|Object} definition Module definition.</span>
<span class="cm">       */</span>
      <span class="nx">Module</span><span class="p">.</span><span class="nx">define</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">new</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">definition</span><span class="p">);</span>
      <span class="p">};</span>
  
      <span class="cm">/**</span>
<span class="cm">       * Require module.</span>
<span class="cm">       * @param {String} id Module ID.</span>
<span class="cm">       * @return {Object} Module.</span>
<span class="cm">       */</span>
      <span class="nx">Module</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">__modules</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">module</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Cannot find module &#39;&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">module</span><span class="p">.</span><span class="nx">_require</span><span class="p">();</span>
      <span class="p">};</span>
  
      <span class="cm">/**</span>
<span class="cm">       * Store named definition.</span>
<span class="cm">       * @param {String} id Module ID.</span>
<span class="cm">       * @param {Function|Object} definition Module definition.</span>
<span class="cm">       * @constructor</span>
<span class="cm">       */</span>
      <span class="kd">function</span> <span class="nx">Module</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">definition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">__modules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Cannot overwrite module &#39;&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">__modules</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  
        <span class="cm">/**</span>
<span class="cm">         * Module ID.</span>
<span class="cm">         * @type {String}</span>
<span class="cm">         */</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
        <span class="cm">/**</span>
<span class="cm">         * Module definition.</span>
<span class="cm">         * @type {Function|Object}</span>
<span class="cm">         */</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">definition</span> <span class="o">=</span> <span class="nx">definition</span><span class="p">;</span>
      <span class="p">}</span>
  
      <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_require</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exports</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">definition</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">require</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">exports</span><span class="p">;</span>
      <span class="p">};</span>
  
      <span class="cm">/**</span>
<span class="cm">       * Extends classical prototype pattern object or modern module pattern object.</span>
<span class="cm">       * `Child.__super__` provides parent prototype.</span>
<span class="cm">       * @param {Function|Object} parent source object.</span>
<span class="cm">       * @param {Function|Object} child destination object.</span>
<span class="cm">       * @return {Function|Object} child object.</span>
<span class="cm">       */</span>
      <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">child</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">child</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="nx">copyDeeply</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">child</span><span class="p">);</span>
        <span class="nx">inheritPrototype</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">child</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">child</span><span class="p">;</span>
      <span class="p">};</span>
  
      <span class="cm">/**</span>
<span class="cm">       * Mix properties.</span>
<span class="cm">       * @return {Object} Mixed object.</span>
<span class="cm">       */</span>
      <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">mix</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span> <span class="p">,</span> <span class="nx">len</span> <span class="p">,</span> <span class="nx">arg</span>
          <span class="p">,</span> <span class="nx">child</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">arg</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">copyDeeply</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">child</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">child</span><span class="p">;</span>
      <span class="p">};</span>
  
      <span class="cm">/**</span>
<span class="cm">       * Bind context with inspected object.</span>
<span class="cm">       * @param {Function} fn   Binding function.</span>
<span class="cm">       * @param {Object} me     Context object.</span>
<span class="cm">       * @return {Function}</span>
<span class="cm">       */</span>
      <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bind</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">me</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">me</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
        <span class="p">};</span>
      <span class="p">};</span>
  
      <span class="k">return</span> <span class="nx">Module</span><span class="p">;</span>
    <span class="p">})()</span>
    <span class="p">,</span> <span class="nx">define</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">define</span><span class="p">;</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;errors.ErrorMessage&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ErrorMessage</span> <span class="o">=</span> <span class="p">{};</span>
    
    <span class="nx">ErrorMessage</span><span class="p">.</span><span class="nx">createInvalidNumberOfParameter</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">&#39;Invalid number of parameters, expected &#39;</span> <span class="o">+</span> <span class="nx">num</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ErrorMessage</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;events.Event&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">Event</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">bubbles</span><span class="p">,</span> <span class="nx">cancelable</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">event</span><span class="p">;</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="nx">bubbles</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">bubbles</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cancelable</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cancelable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Event</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Event</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">bubbles</span><span class="p">,</span> <span class="nx">cancelable</span><span class="p">);</span>
      <span class="p">}</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="k">instanceof</span> <span class="nx">Event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
        <span class="nx">bubbles</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">bubbles</span><span class="p">;</span>
        <span class="nx">cancelable</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">cancelable</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentTarget</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bubbles</span> <span class="o">=</span> <span class="nx">bubbles</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cancelable</span> <span class="o">=</span> <span class="nx">cancelable</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_isPropagationStopped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_isPropagationStoppedImmediately</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_isDefaultPrevented</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">formatToString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="p">};</span>
    
    <span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stopPropagation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_isPropagationStopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stopImmediatePropagation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_isPropagationStopped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_isPropagationStoppedImmediately</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isDefaultPrevented</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_isDefaultPrevented</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Event</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">preventDefault</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_isDefaultPrevented</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Event</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;events.EventEmitter&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Event</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;muon.events.Event&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">EventPhase</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;muon.events.EventPhase&#39;</span><span class="p">);</span>
    
    <span class="kd">function</span> <span class="nx">EventEmitter</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_events</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="p">}</span>
    
    <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">useCapture</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">type</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ErrorMessage</span><span class="p">(</span><span class="s2">&quot;EventEmitter#addEventListener: type isn&#39;t string&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">listener</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ErrorMessage</span><span class="p">(</span><span class="s2">&quot;EventEmitter#addEventListener: listener isn&#39;t function&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">useCapture</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">useCapture</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">priority</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">push</span><span class="p">({</span>
        <span class="nx">listener</span>  <span class="o">:</span> <span class="nx">listener</span><span class="p">,</span>
        <span class="nx">useCapture</span><span class="o">:</span> <span class="nx">useCapture</span><span class="p">,</span>
        <span class="nx">priority</span>  <span class="o">:</span> <span class="nx">priority</span>
      <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">sort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_sortOnPriorityInDescendingOrder</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_sortOnPriorityInDescendingOrder</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">priority</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">priority</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">off</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">storage</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">storage</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">storage</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">listener</span> <span class="o">===</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">storage</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">storage</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">EventEmitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">objs</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">event</span> <span class="k">instanceof</span> <span class="nx">Event</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ErrorMessage</span><span class="p">(</span><span class="s2">&quot;EventEmitter#dispatchEvent: event isn&#39;t Event&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    
      <span class="nx">event</span><span class="p">.</span><span class="nx">currentTarget</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">objs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_events</span><span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">obj</span> <span class="o">=</span> <span class="nx">objs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">useCapture</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventPhase</span> <span class="o">===</span> <span class="nx">EventPhase</span><span class="p">.</span><span class="nx">CAPTURING_PHASE</span> <span class="o">||</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">useCapture</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">event</span><span class="p">.</span><span class="nx">eventPhase</span> <span class="o">!==</span> <span class="nx">EventPhase</span><span class="p">.</span><span class="nx">CAPTURING_PHASE</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">listener</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
              <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
            <span class="p">})(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">_isPropagationStoppedImmediately</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">event</span><span class="p">.</span><span class="nx">_isDefaultPrevented</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">EventEmitter</span><span class="p">;</span>
    
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;events.EventPhase&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">EventPhase</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">CAPTURING_PHASE</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">AT_TARGET</span>      <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">BUBBLING_PHASE</span> <span class="o">:</span> <span class="mi">3</span>
    <span class="p">};</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">EventPhase</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;geom.Matrix&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Point</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;geom.Point&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">sin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span>
      <span class="p">,</span> <span class="nx">cos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span>
      <span class="p">,</span> <span class="nx">tan</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">tan</span><span class="p">;</span>
    
    <span class="kd">function</span> <span class="nx">Matrix</span><span class="p">(</span><span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">,</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">=</span> <span class="nx">xx</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">xx</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">=</span> <span class="nx">xy</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">xy</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">=</span> <span class="nx">yx</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">yx</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">=</span> <span class="nx">yy</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">yy</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ox</span> <span class="o">=</span> <span class="nx">ox</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">ox</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">oy</span> <span class="o">=</span> <span class="nx">oy</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">oy</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">identity</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ox</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">oy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xx</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">xy</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">yx</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">yy</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">oy</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">ox</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">oy</span> <span class="o">+</span> <span class="s2">&quot;\n0 0 1&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_arg</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">,</span> <span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">;</span>
      <span class="nx">xx</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">yy</span><span class="p">,</span> <span class="nx">ox</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">oy</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_apply</span><span class="p">(</span><span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">,</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_apply</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">,</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">=</span> <span class="nx">xx</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">=</span> <span class="nx">xy</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">=</span> <span class="nx">yx</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">=</span> <span class="nx">yy</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ox</span> <span class="o">=</span> <span class="nx">ox</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">oy</span> <span class="o">=</span> <span class="nx">oy</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">setTransform</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xx</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">xy</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">yx</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">yy</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">oy</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">concat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_arg</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">,</span> <span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">;</span>
      <span class="nx">xx</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">yy</span><span class="p">,</span> <span class="nx">ox</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">oy</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_concat</span><span class="p">(</span><span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">,</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_concat</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">,</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">_ox</span><span class="p">,</span> <span class="nx">_oy</span><span class="p">,</span> <span class="nx">_xx</span><span class="p">,</span> <span class="nx">_xy</span><span class="p">,</span> <span class="nx">_yx</span><span class="p">,</span> <span class="nx">_yy</span><span class="p">;</span>
      <span class="nx">_xx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xx</span><span class="p">;</span>
      <span class="nx">_xy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xy</span><span class="p">;</span>
      <span class="nx">_yx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">yx</span><span class="p">;</span>
      <span class="nx">_yy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">yy</span><span class="p">;</span>
      <span class="nx">_ox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ox</span><span class="p">;</span>
      <span class="nx">_oy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oy</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">=</span> <span class="nx">xx</span> <span class="o">*</span> <span class="nx">_xx</span> <span class="o">+</span> <span class="nx">yx</span> <span class="o">*</span> <span class="nx">_xy</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">=</span> <span class="nx">xy</span> <span class="o">*</span> <span class="nx">_xx</span> <span class="o">+</span> <span class="nx">yy</span> <span class="o">*</span> <span class="nx">_xy</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">=</span> <span class="nx">xx</span> <span class="o">*</span> <span class="nx">_yx</span> <span class="o">+</span> <span class="nx">yx</span> <span class="o">*</span> <span class="nx">_yy</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">=</span> <span class="nx">xy</span> <span class="o">*</span> <span class="nx">_yx</span> <span class="o">+</span> <span class="nx">yy</span> <span class="o">*</span> <span class="nx">_yy</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ox</span> <span class="o">=</span> <span class="nx">xx</span> <span class="o">*</span> <span class="nx">_ox</span> <span class="o">+</span> <span class="nx">yx</span> <span class="o">*</span> <span class="nx">_oy</span> <span class="o">+</span> <span class="nx">ox</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">oy</span> <span class="o">=</span> <span class="nx">xy</span> <span class="o">*</span> <span class="nx">_ox</span> <span class="o">+</span> <span class="nx">yy</span> <span class="o">*</span> <span class="nx">_oy</span> <span class="o">+</span> <span class="nx">oy</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tx</span><span class="p">,</span> <span class="nx">ty</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_concat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">tx</span><span class="p">,</span> <span class="nx">ty</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">translatePoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_arg</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_concat</span><span class="p">(</span><span class="nx">sx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">scalePoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_arg</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">angle</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">s</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">cos</span><span class="p">(</span><span class="nx">angle</span><span class="p">);</span>
      <span class="nx">s</span> <span class="o">=</span> <span class="nx">sin</span><span class="p">(</span><span class="nx">angle</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_concat</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="o">-</span><span class="nx">s</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">skew</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">skewX</span><span class="p">,</span> <span class="nx">skewY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_concat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">tan</span><span class="p">(</span><span class="nx">skewY</span><span class="p">),</span> <span class="nx">tan</span><span class="p">(</span><span class="nx">skewX</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">ox</span><span class="p">,</span> <span class="nx">oy</span><span class="p">,</span> <span class="nx">xx</span><span class="p">,</span> <span class="nx">xy</span><span class="p">,</span> <span class="nx">yx</span><span class="p">,</span> <span class="nx">yy</span><span class="p">;</span>
      <span class="nx">xx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xx</span><span class="p">;</span>
      <span class="nx">xy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">xy</span><span class="p">;</span>
      <span class="nx">yx</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">yx</span><span class="p">;</span>
      <span class="nx">yy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">yy</span><span class="p">;</span>
      <span class="nx">ox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ox</span><span class="p">;</span>
      <span class="nx">oy</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">oy</span><span class="p">;</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">xx</span> <span class="o">*</span> <span class="nx">yy</span> <span class="o">-</span> <span class="nx">xy</span> <span class="o">*</span> <span class="nx">yx</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">=</span> <span class="nx">yy</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">=</span> <span class="o">-</span><span class="nx">xy</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">=</span> <span class="o">-</span><span class="nx">yx</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">=</span> <span class="nx">xx</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ox</span> <span class="o">=</span> <span class="p">(</span><span class="nx">yx</span> <span class="o">*</span> <span class="nx">oy</span> <span class="o">-</span> <span class="nx">yy</span> <span class="o">*</span> <span class="nx">ox</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">oy</span> <span class="o">=</span> <span class="p">(</span><span class="nx">xy</span> <span class="o">*</span> <span class="nx">ox</span> <span class="o">-</span> <span class="nx">xx</span> <span class="o">*</span> <span class="nx">oy</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">transformPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_arg</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">*</span> <span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">*</span> <span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">oy</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deltaTransformPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_arg</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">_arg</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">xx</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">yx</span> <span class="o">*</span> <span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">xy</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">yy</span> <span class="o">*</span> <span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createBox</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">scaleX</span><span class="p">,</span> <span class="nx">scaleY</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">,</span> <span class="nx">tx</span><span class="p">,</span> <span class="nx">ty</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">s</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rotation</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rotation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ty</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">cos</span><span class="p">(</span><span class="nx">rotation</span><span class="p">);</span>
      <span class="nx">s</span> <span class="o">=</span> <span class="nx">sin</span><span class="p">(</span><span class="nx">rotation</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_concat</span><span class="p">(</span><span class="nx">scaleX</span> <span class="o">*</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">scaleY</span> <span class="o">*</span> <span class="nx">s</span><span class="p">,</span> <span class="o">-</span><span class="nx">scaleX</span> <span class="o">*</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">scaleY</span> <span class="o">*</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">tx</span><span class="p">,</span> <span class="nx">ty</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Matrix</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createGradientBox</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rotation</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rotation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">createBox</span><span class="p">(</span><span class="nx">width</span> <span class="o">/</span> <span class="mf">1638.4</span><span class="p">,</span> <span class="nx">height</span> <span class="o">/</span> <span class="mf">1638.4</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">,</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Matrix</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;geom.Point&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Matrix</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;geom.Matrix&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">sin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span>
      <span class="p">,</span> <span class="nx">cos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span>
      <span class="p">,</span> <span class="nx">sqrt</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span>
      <span class="p">,</span> <span class="nx">atan2</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">;</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">polar</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">distance</span><span class="p">,</span> <span class="nx">angle</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">distance</span> <span class="o">*</span> <span class="nx">cos</span><span class="p">(</span><span class="nx">angle</span><span class="p">),</span> <span class="nx">distance</span> <span class="o">*</span> <span class="nx">sin</span><span class="p">(</span><span class="nx">angle</span><span class="p">));</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt0</span><span class="p">,</span> <span class="nx">pt1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">pt0</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">pt1</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pt0</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">pt1</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">subtract</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt0</span><span class="p">,</span> <span class="nx">pt1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">pt0</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">pt1</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">pt0</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">pt1</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">multiple</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">pt</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">num</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">divide</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">pt</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">num</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">crossProduct</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">distance</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">distance</span> <span class="o">*</span> <span class="nx">sin</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">angle</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">dotProduct</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">distance</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">between</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">dst</span><span class="p">,</span> <span class="nx">ratio</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ratio</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ratio</span> <span class="o">=</span> <span class="p">.</span><span class="mi">5</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">src</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">,</span> <span class="nx">src</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">src</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Coordination position.</span>
<span class="cm">     * @param {Number} x    Horizontal position.</span>
<span class="cm">     * @param {Number} y    Vertical position.</span>
<span class="cm">     * @constructor</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">Point</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/**</span>
<span class="cm">       * Horizontal position.</span>
<span class="cm">       * @type {Number}</span>
<span class="cm">       */</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    
      <span class="cm">/**</span>
<span class="cm">       * Vertical position.</span>
<span class="cm">       * @type {Number}</span>
<span class="cm">       */</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">distance</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">sqrt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">atan2</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Point</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subtract</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multiple</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">num</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">num</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">divide</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">/=</span> <span class="nx">num</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">/=</span> <span class="nx">num</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">equals</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">===</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">normalize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">thickness</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ratio</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">thickness</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">thickness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">ratio</span> <span class="o">=</span> <span class="nx">thickness</span> <span class="o">/</span> <span class="nx">sqrt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">ratio</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">ratio</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Point</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">matrix</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">m</span><span class="p">;</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="nx">m</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">matrix</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ox</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">oy</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Point</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;geom.Rectangle&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Matrix</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;geom.Matrix&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">min</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span>
      <span class="p">,</span> <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span>
      <span class="p">,</span> <span class="nx">floor</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span>
      <span class="p">,</span> <span class="nx">ceil</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span>
      <span class="p">,</span> <span class="nx">sqrt</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">;</span>
    
    <span class="kd">function</span> <span class="nx">Rectangle</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">x</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">width</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">height</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;[Rectangle x=&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot; y=&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="s2">&quot; width=&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+</span> <span class="s2">&quot; height=&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">right</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clone</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Rectangle</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">contains</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">containsPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">contain</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">x</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">y</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">containPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">contain</span><span class="p">(</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">dx</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">dy</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">offsetPoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inflate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dw</span><span class="p">,</span> <span class="nx">dh</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+=</span> <span class="nx">dw</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">dh</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inflatePoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">+=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deflate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dw</span><span class="p">,</span> <span class="nx">dh</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-=</span> <span class="nx">dw</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">dh</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deflatePoint</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">pt</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">-=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">-=</span> <span class="nx">pt</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">union</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">b2</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">r1</span><span class="p">,</span> <span class="nx">r2</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">w</span><span class="p">;</span>
      <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="nx">r1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
      <span class="nx">r2</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">r1</span> <span class="o">&gt;</span> <span class="nx">r2</span> <span class="o">?</span> <span class="nx">r1</span> <span class="o">:</span> <span class="nx">r2</span><span class="p">;</span>
      <span class="nx">w</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">-</span> <span class="nx">l</span><span class="p">;</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="nx">b1</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="nx">b2</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">b1</span> <span class="o">&gt;</span> <span class="nx">b2</span> <span class="o">?</span> <span class="nx">b1</span> <span class="o">:</span> <span class="nx">b2</span><span class="p">;</span>
      <span class="nx">h</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">-</span> <span class="nx">t</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">w</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">w</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">h</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">intersects</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">w</span><span class="p">;</span>
      <span class="nx">l</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
      <span class="nx">w</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">-</span> <span class="nx">l</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">w</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
      <span class="nx">h</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">-</span> <span class="nx">t</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">intersection</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">w</span><span class="p">;</span>
      <span class="nx">l</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
      <span class="nx">w</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">-</span> <span class="nx">l</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">w</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Rectangle</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
      <span class="nx">h</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">-</span> <span class="nx">t</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">Rectangle</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Rectangle</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">measureFarDistance</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">dl</span><span class="p">,</span> <span class="nx">dr</span><span class="p">,</span> <span class="nx">dt</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">min</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">l</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
      <span class="nx">dl</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">l</span><span class="p">;</span>
      <span class="nx">dr</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">r</span><span class="p">;</span>
      <span class="nx">dt</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">db</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">b</span><span class="p">;</span>
      <span class="nx">dl</span> <span class="o">=</span> <span class="nx">dl</span> <span class="o">*</span> <span class="nx">dl</span><span class="p">;</span>
      <span class="nx">dr</span> <span class="o">=</span> <span class="nx">dr</span> <span class="o">*</span> <span class="nx">dr</span><span class="p">;</span>
      <span class="nx">dt</span> <span class="o">=</span> <span class="nx">dt</span> <span class="o">*</span> <span class="nx">dt</span><span class="p">;</span>
      <span class="nx">db</span> <span class="o">=</span> <span class="nx">db</span> <span class="o">*</span> <span class="nx">db</span><span class="p">;</span>
      <span class="nx">min</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="nx">dl</span> <span class="o">+</span> <span class="nx">dt</span><span class="p">,</span> <span class="nx">dr</span> <span class="o">+</span> <span class="nx">dt</span><span class="p">,</span> <span class="nx">dr</span> <span class="o">+</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">dl</span> <span class="o">+</span> <span class="nx">db</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">sqrt</span><span class="p">(</span><span class="nx">min</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">adjustOuter</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">ceil</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">ceil</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">Rectangle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">matrix</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">lb</span><span class="p">,</span> <span class="nx">lt</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">rb</span><span class="p">,</span> <span class="nx">rt</span><span class="p">,</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">lt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="nx">rt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
      <span class="nx">rb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
      <span class="nx">lb</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
      <span class="nx">lt</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">matrix</span><span class="p">);</span>
      <span class="nx">rt</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">matrix</span><span class="p">);</span>
      <span class="nx">rb</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">matrix</span><span class="p">);</span>
      <span class="nx">lb</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">matrix</span><span class="p">);</span>
      <span class="nx">l</span> <span class="o">=</span> <span class="nx">min</span><span class="p">(</span><span class="nx">lt</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">ox</span><span class="p">);</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="nx">lt</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">ox</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">ox</span><span class="p">);</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">min</span><span class="p">(</span><span class="nx">lt</span><span class="p">.</span><span class="nx">oy</span><span class="p">,</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">oy</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">oy</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">oy</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="nx">lt</span><span class="p">.</span><span class="nx">oy</span><span class="p">,</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">oy</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">oy</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">oy</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">-</span> <span class="nx">l</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">-</span> <span class="nx">t</span><span class="p">;</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Rectangle</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;net.url&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">querystring</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;muon.serializer.querystring&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">array</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;muon.utils.array&#39;</span><span class="p">);</span>
    
    <span class="kd">var</span> <span class="nx">R_URL</span> <span class="o">=</span> <span class="sr">/^((\w+:)(\/*)?(?:([^@]*)@)?(([^\/]+?)(?::(\d*))?))((\/[^\?#]*)?(\?([^#]*)?)?)?(#.*)?$/</span><span class="p">;</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">urlStr</span><span class="p">,</span> <span class="nx">parseQueryString</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">parseQueryString</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">parseQueryString</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">matched</span> <span class="o">=</span> <span class="nx">urlStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">R_URL</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">protocol</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">slashes</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">pathname</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">search</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
        <span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">opt</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">;</span>
      
      <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">href</span>    <span class="o">:</span> <span class="nx">href</span><span class="p">,</span>
        <span class="nx">origin</span>  <span class="o">:</span> <span class="nx">origin</span><span class="p">,</span>
        <span class="nx">protocol</span><span class="o">:</span> <span class="nx">protocol</span><span class="p">,</span>
        <span class="nx">host</span>    <span class="o">:</span> <span class="nx">host</span><span class="p">,</span>
        <span class="nx">hostname</span><span class="o">:</span> <span class="nx">hostname</span>
      <span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">parseQueryString</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">query</span> <span class="o">=</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">opt</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">auth</span>    <span class="o">:</span> <span class="nx">auth</span><span class="p">,</span>
        <span class="nx">port</span>    <span class="o">:</span> <span class="nx">port</span><span class="p">,</span>
        <span class="nx">path</span>    <span class="o">:</span> <span class="nx">path</span><span class="p">,</span>
        <span class="nx">pathname</span><span class="o">:</span> <span class="nx">pathname</span><span class="p">,</span>
        <span class="nx">search</span>  <span class="o">:</span> <span class="nx">search</span><span class="p">,</span>
        <span class="nx">query</span>   <span class="o">:</span> <span class="nx">query</span><span class="p">,</span>
        <span class="nx">hash</span>    <span class="o">:</span> <span class="nx">hash</span>
      <span class="p">};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">slashes</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">slashes</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">path</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">obj</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
          <span class="nx">obj</span><span class="p">.</span><span class="nx">href</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">opt</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">urlObj</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">protocol</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">protocol</span>
        <span class="p">,</span> <span class="nx">protocolPostfix</span> <span class="o">=</span> <span class="nx">__indexOf</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">URL</span><span class="p">.</span><span class="nx">CSS</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;://&#39;</span> <span class="o">:</span> <span class="s1">&#39;:&#39;</span>
        <span class="p">,</span> <span class="nx">auth</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">auth</span>
        <span class="p">,</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">host</span>
        <span class="p">,</span> <span class="nx">hostname</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">hostname</span>
        <span class="p">,</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">port</span>
        <span class="p">,</span> <span class="nx">pathname</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">pathname</span>
        <span class="p">,</span> <span class="nx">search</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">search</span>
        <span class="p">,</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">query</span>
        <span class="p">,</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">urlObj</span><span class="p">.</span><span class="nx">hash</span><span class="p">;</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="nx">host</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">host</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">hostname</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">host</span> <span class="o">+=</span> <span class="nx">hostname</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">port</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">host</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pathname</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">pathname</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">search</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">search</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">search</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">query</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">search</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hash</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">hash</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">protocol</span> <span class="o">+</span> <span class="nx">protocolPostfix</span> <span class="o">+</span> <span class="nx">host</span> <span class="o">+</span> <span class="nx">pathname</span> <span class="o">+</span> <span class="nx">search</span> <span class="o">+</span> <span class="nx">hash</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">};</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;serializer.querystring&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">encode</span> <span class="o">=</span> <span class="nb">encodeURIComponent</span><span class="p">;</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">stringify</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span>
        <span class="p">,</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">encode</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]));</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">str</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{};</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>
        <span class="p">,</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">,</span> <span class="nx">kv</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ErrorMessage</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">kv</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>
        <span class="nx">obj</span><span class="p">[</span><span class="nx">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">encode</span><span class="p">(</span><span class="nx">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
    <span class="p">};</span>
    
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;timers.Ticker&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">EventEmitter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;muon.events.EventEmitter&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span> <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestAnimationFrame</span> <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">mozRequestAnimationFrame</span> <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">msRequestAnimationFrame</span> <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">oRequestAnimationFrame</span> <span class="o">||</span>
        <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">66</span><span class="p">);</span>
            <span class="k">return</span> <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
          <span class="p">};</span>
        <span class="p">}();</span>
    <span class="p">}();</span>
    
    <span class="kd">function</span> <span class="nx">Ticker</span><span class="p">()</span> <span class="p">{</span>
    
    <span class="p">}</span>
    
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Ticker</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="nx">define</span><span class="p">(</span><span class="s1">&#39;utils.array&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_random</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span>
      <span class="p">,</span> <span class="nx">_shift</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shift</span>
      <span class="p">,</span> <span class="nx">_slice</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span>
      <span class="p">,</span> <span class="nx">_toString</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">;</span>
    
    <span class="cm">/**</span>
<span class="cm">     * @type {*|Function}</span>
<span class="cm">     */</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="o">||</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;[object Array]&#39;</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">indexOf</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">searchElement</span><span class="p">,</span> <span class="nx">fromIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">searchElement</span><span class="p">,</span> <span class="nx">fromIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;array.indexOf called on null or undefined&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    
        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fromIndex</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fromIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">fromIndex</span> <span class="o">+</span> <span class="nx">len</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">fromIndex</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">searchElement</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="cm">/*</span>
<span class="cm">     should be tested</span>
<span class="cm">     */</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">lastIndexOf</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lastIndexOf</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">searchElement</span><span class="p">,</span> <span class="nx">fromIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">searchElement</span><span class="p">,</span> <span class="nx">fromIndex</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
    
        <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    
        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fromIndex</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">len</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">fromIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">len</span> <span class="o">+</span> <span class="nx">fromIndex</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">fromIndex</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">searchElement</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">include</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">compact</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">,</span> <span class="nx">newArr</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">newArr</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">newArr</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="k">delete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">,</span> <span class="nx">deleted</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">deleted</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="nx">deleted</span> <span class="o">=</span> <span class="nx">deleted</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">deleted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">deleted</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">deleteAt</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">deleted</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">deleted</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">deleted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Select value in a random drawing.</span>
<span class="cm">     * @param {Array} arr</span>
<span class="cm">     * @param {Number} length</span>
<span class="cm">     * @return {*|Array}</span>
<span class="cm">     */</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">random</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="nx">_random</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">arr</span> <span class="o">=</span> <span class="nx">_slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">hits</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">length</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">hits</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="nx">_random</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">hits</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="cm">/**</span>
<span class="cm">     * Shuffle array</span>
<span class="cm">     * @param {Array} arr</span>
<span class="cm">     * @return {*}</span>
<span class="cm">     */</span>
    <span class="nx">exports</span><span class="p">.</span><span class="nx">shuffle</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arr</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
      <span class="p">}</span>
    
      <span class="nx">arr</span> <span class="o">=</span> <span class="nx">_slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">,</span> <span class="nx">j</span>
        <span class="p">,</span> <span class="nx">v</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">j</span> <span class="o">=</span> <span class="nx">_random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">i</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">v</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="nx">arr</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filter</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span> <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisObject</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">thisObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">val</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">arr</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisObject</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">arr</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">forEach</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forEach</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">forEach</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span> <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisObject</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">thisObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">val</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisObject</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">every</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">every</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callvack</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">every</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span> <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisObject</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">thisObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">val</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">arr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisObject</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">arr</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span> <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisObject</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">thisObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">val</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisObject</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">arr</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">some</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">some</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">some</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span> <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">thisObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">thisObject</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">thisObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">val</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">(</span><span class="nx">fo</span><span class="p">(</span><span class="nx">arr</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">thisObject</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">arr</span><span class="p">))))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span> <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_ref</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">initialValue</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">initialValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">initialValue</span> <span class="o">===</span> <span class="kc">null</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">initialValue</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">initialValue</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">];</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_ref</span> <span class="o">=</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&gt;=</span> <span class="nx">_ref</span><span class="p">;</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">initialValue</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">initialValue</span><span class="p">,</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">val</span><span class="p">],</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">initialValue</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduceRight</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">?</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduceRight</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_shift</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">),</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">}</span> <span class="o">:</span>
      <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">_i</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">initialValue</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">initialValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">callback</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">initialValue</span> <span class="o">===</span> <span class="kc">null</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">initialValue</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">do</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">initialValue</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="o">--</span><span class="p">];</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">+=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="k">in</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">initialValue</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">initialValue</span><span class="p">,</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">val</span><span class="p">],</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">initialValue</span><span class="p">;</span>
      <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">toArray</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arrayLikeObject</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">_slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arrayLikeObject</span><span class="p">);</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">unique</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">storage</span><span class="p">;</span>
      <span class="nx">storage</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">elem</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">elem</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">elem</span> <span class="k">in</span> <span class="nx">storage</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">arr</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">storage</span><span class="p">[</span><span class="nx">elem</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">rotate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">index</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">shift</span><span class="p">());</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">index</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">index</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">arr</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
    <span class="p">};</span>
    
    <span class="nx">exports</span><span class="p">.</span><span class="nx">transpose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">cols</span><span class="p">,</span> <span class="nx">columns</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">row</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_j</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_len1</span><span class="p">;</span>
      <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">columns</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">row</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ArrayUtil</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">row</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;Element isn\&#39;t Array.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">cols</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">cols</span> <span class="o">!==</span> <span class="nx">columns</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Element size differ (&quot;</span> <span class="o">+</span> <span class="nx">cols</span> <span class="o">+</span> <span class="s2">&quot; should be &quot;</span> <span class="o">+</span> <span class="nx">columns</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">columns</span> <span class="o">=</span> <span class="nx">cols</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">cols</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">results</span><span class="p">[</span><span class="nx">cols</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">_j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len1</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_j</span> <span class="o">&lt;</span> <span class="nx">_len1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">++</span><span class="nx">_j</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">elem</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
          <span class="nx">results</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
    <span class="p">};</span>
    
  <span class="p">});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">require</span><span class="p">;</span>

<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 